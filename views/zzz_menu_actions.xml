<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
    ДЕЙСТВИЯ ПО МЕНЮ - РАСПОЛОЖИТЬ ПОСЛЕДНИМ В МАНИФЕСТЕ
    Все действия (actions) для меню, определенных в 000_main_menus.xml
    -->

    <!-- ===== VM MANAGEMENT ACTIONS ===== -->
    <!-- ОСНОВНОЙ VM Instances action (отсутствовал!) -->
    <record id="action_vm_instance" model="ir.actions.act_window">
        <field name="name">VM Instances</field>
        <field name="res_model">vm_rental.machine</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first VM Instance!
            </p>
            <p>
                VM instances represent virtual machines managed through this system.
            </p>
        </field>
    </record>

    <!-- VM Instances action (альтернативное имя) -->
    <record id="action_vm_instances" model="ir.actions.act_window">
        <field name="name">VM Instances</field>
        <field name="res_model">vm_rental.machine</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first VM Instance!
            </p>
            <p>
                VM instances represent virtual machines managed through this system.
            </p>
        </field>
    </record>

    <!-- VM Orders action -->
    <record id="action_vm_orders" model="ir.actions.act_window">
        <field name="name">VM Orders</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('order_line.product_id.hypervisor_server_id', '!=', False)]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No VM orders yet!
            </p>
            <p>
                VM orders contain products configured as virtual machines.
            </p>
        </field>
    </record>

    <!-- Link Existing VMs action -->
    <record id="action_linking_job" model="ir.actions.act_window">
        <field name="name">Link Existing VMs</field>
        <field name="res_model">vm_rental.linking_job</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a linking job to import existing VMs
            </p>
            <p>
                Use this feature to import VMs that already exist on your hypervisors
                into Odoo for management.
            </p>
        </field>
    </record>

    <!-- Configuration Wizard action -->
    <record id="action_vm_config_wizard" model="ir.actions.act_window">
        <field name="name">VM Configuration Wizard</field>
        <field name="res_model">vm.config.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{
            'default_config_type': 'custom',
            'default_cores': 1,
            'default_memory': 1024,
            'default_disk': 10
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Welcome to Configuration Wizard!
            </p>
            <p>
                Configure VM settings easily with this wizard.
            </p>
        </field>
    </record>

    <!-- Bulk Operations action -->
    <record id="action_vm_bulk_operations" model="ir.actions.act_window">
        <field name="name">Bulk Operations</field>
        <field name="res_model">vm.bulk.operations.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="model_vm_rental_machine"/>
        <field name="binding_view_types">list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Start bulk operations!
            </p>
            <p>
                Perform operations on multiple VMs at once.
            </p>
        </field>
    </record>

    <!-- VM Snapshots action -->
    <record id="action_vm_snapshots" model="ir.actions.act_window">
        <field name="name">VM Snapshots</field>
        <field name="res_model">vm.snapshot</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No snapshots created yet!
            </p>
            <p>
                Snapshots allow you to save and restore VM states.
            </p>
        </field>
    </record>

    <!-- ===== HYPERVISOR ACTIONS ===== -->
    <!-- Hypervisor Servers action -->
    <record id="action_hypervisor_servers" model="ir.actions.act_window">
        <field name="name">Hypervisor Servers</field>
        <field name="res_model">hypervisor.server</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Add your first hypervisor server!
            </p>
            <p>
                Configure Proxmox, VMware or other hypervisor connections.
            </p>
        </field>
    </record>

    <!-- Alternative action name for compatibility -->
    <record id="action_hypervisor_server" model="ir.actions.act_window">
        <field name="name">Hypervisor Servers</field>
        <field name="res_model">hypervisor.server</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Add your first hypervisor server!
            </p>
            <p>
                Configure Proxmox, VMware or other hypervisor connections.
            </p>
        </field>
    </record>

    <!-- VM Templates action -->
    <record id="action_vm_templates" model="ir.actions.act_window">
        <field name="name">VM Templates</field>
        <field name="res_model">hypervisor.template</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No templates available!
            </p>
            <p>
                Templates are used to create new VM instances quickly.
            </p>
        </field>
    </record>

    <!-- ===== PRICING ACTIONS ===== -->
    <!-- Pricing Plans action -->
    <record id="action_vm_pricing_plans" model="ir.actions.act_window">
        <field name="name">Pricing Plans</field>
        <field name="res_model">hypervisor.server.pricing</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first pricing plan!
            </p>
            <p>
                Pricing plans define costs for CPU, RAM, disk and other resources.
            </p>
        </field>
    </record>

    <!-- Pricing Calculator action -->
    <record id="action_vm_pricing_calculator" model="ir.actions.act_window">
        <field name="name">Pricing Calculator</field>
        <field name="res_model">vm.pricing.calculator</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Calculate VM pricing!
            </p>
            <p>
                Use the calculator to estimate costs for different VM configurations.
            </p>
        </field>
    </record>

    <!-- Mass Price Update Wizard action -->
    <record id="action_mass_price_update_wizard" model="ir.actions.act_window">
        <field name="name">Mass Price Update Wizard</field>
        <field name="res_model">vm.pricing.calculator</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{'default_operation': 'mass_update'}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Update prices for multiple VM products at once
            </p>
            <p>
                This wizard helps you update prices for all VM products with auto-calculation enabled.
            </p>
        </field>
    </record>

    <!-- Pricing Dashboard action -->
    <record id="action_vm_pricing_dashboard" model="ir.actions.act_window">
        <field name="name">Pricing Dashboard</field>
        <field name="res_model">vm.pricing.dashboard</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Pricing dashboard overview!
            </p>
            <p>
                Monitor pricing configuration and statistics.
            </p>
        </field>
    </record>

    <!-- Alternative action name for compatibility -->
    <record id="action_pricing_dashboard" model="ir.actions.act_window">
        <field name="name">Pricing Dashboard</field>
        <field name="res_model">vm.pricing.dashboard</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Pricing dashboard overview!
            </p>
            <p>
                Monitor pricing configuration and statistics.
            </p>
        </field>
    </record>

    <!-- ===== REPORTS ACTIONS ===== -->
    <!-- VM Reports action -->
    <record id="action_vm_reports" model="ir.actions.act_window">
        <field name="name">VM Reports</field>
        <field name="res_model">vm_rental.machine</field>
        <field name="view_mode">graph,pivot,tree</field>
        <field name="domain">[]</field>
        <field name="context">{'search_default_group_by_state': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Generate your first VM report!
            </p>
            <p>
                Analyze VM usage, performance and billing data.
            </p>
        </field>
    </record>

    <!-- VM Admin Report action -->
    <record id="action_vm_admin_report" model="ir.actions.act_window">
        <field name="name">All Virtual Machines</field>
        <field name="res_model">vm_rental.machine</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No VMs found!
            </p>
            <p>
                This report shows all virtual machines in the system.
            </p>
        </field>
    </record>

    <!-- Alternative action name for compatibility -->
    <record id="action_report_vm_admin" model="ir.actions.act_window">
        <field name="name">All Virtual Machines</field>
        <field name="res_model">vm_rental.machine</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No VMs found!
            </p>
            <p>
                This report shows all virtual machines in the system.
            </p>
        </field>
    </record>

    <!-- ===== USER MANAGEMENT ACTIONS ===== -->
    <!-- VM Users Dashboard action -->
    <record id="action_vm_users_dashboard" model="ir.actions.act_window">
        <field name="name">VM Users Dashboard</field>
        <field name="res_model">vm.user.manager</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Welcome to VM Users Dashboard!
            </p>
            <p>
                Manage user access and permissions for VM functionality.
                You can assign VM roles through the Settings.
            </p>
        </field>
    </record>

    <!-- VM Administrators action -->
    <record id="action_vm_admins_list" model="ir.actions.act_window">
        <field name="name">VM Administrators</field>
        <field name="res_model">res.users</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('groups_id', 'in', [ref('vm_rental.group_vm_rental_admin')])]</field>
        <field name="context">{'default_groups_id': [(4, ref('vm_rental.group_vm_rental_admin'))]}</field>
    </record>

    <!-- VM Managers action -->
    <record id="action_vm_managers_list" model="ir.actions.act_window">
        <field name="name">VM Managers</field>
        <field name="res_model">res.users</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('groups_id', 'in', [ref('vm_rental.group_vm_rental_manager')])]</field>
        <field name="context">{'default_groups_id': [(4, ref('vm_rental.group_vm_rental_manager'))]}</field>
    </record>

    <!-- Users without VM Access action -->
    <record id="action_users_without_vm_access" model="ir.actions.act_window">
        <field name="name">Users without VM Access</field>
        <field name="res_model">res.users</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('groups_id', 'not in', [ref('vm_rental.group_vm_rental_manager'), ref('vm_rental.group_vm_rental_admin')])]</field>
    </record>

    <!-- ===== TOOLS ACTIONS (Server Actions) ===== -->
    <!-- Create VM Products server action -->
    <record id="action_create_vm_products" model="ir.actions.server">
        <field name="name">Create VM Product Variants</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="code">
created = model.create_vm_product_variants()
action = {
    'type': 'ir.actions.act_window',
    'name': 'Created VM Products',
    'res_model': 'product.template',
    'view_mode': 'tree,form',
    'domain': [('id', 'in', created.ids)],
}
        </field>
    </record>

    <!-- Update All Product Prices server action -->
    <record id="action_update_all_product_prices" model="ir.actions.server">
        <field name="name">Update All Product Prices</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="code">
updated_count = 0
products = model.search([
    ('hypervisor_server_id', '!=', False)
])

for product in products:
    # Простая логика обновления цен - можно расширить позже
    if hasattr(product, 'list_price') and product.list_price == 0:
        # Базовая цена на основе ресурсов
        base_price = (product.cores or 1) * 5 + (product.memory or 1024) / 1024 * 2 + (product.disk or 10) * 0.1
        product.write({'list_price': base_price})
        updated_count += 1

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Price Update Complete',
        'message': 'Updated prices for %s VM products' % updated_count,
        'type': 'success',
        'sticky': False,
    }
}
        </field>
    </record>

    <!-- Create Default Pricing Plans server action -->
    <record id="action_create_default_pricing_plans" model="ir.actions.server">
        <field name="name">Create Default Pricing Plans</field>
        <field name="model_id" ref="model_hypervisor_server"/>
        <field name="state">code</field>
        <field name="code">
created_count = 0
servers = model.search([])

for server in servers:
    # Проверяем, есть ли уже план ценообразования
    existing_pricing = env['hypervisor.server.pricing'].search([
        ('server_id', '=', server.id),
        ('active', '=', True)
    ], limit=1)

    if not existing_pricing:
        # Создаем базовый план ценообразования
        pricing_plan = env['hypervisor.server.pricing'].create({
            'name': 'Default Pricing - %s' % server.name,
            'server_id': server.id,
            'price_per_core': 5.0,
            'price_per_gb_ram': 2.0,
            'price_per_gb_disk': 0.1,
            'os_multiplier': 1.5,  # 50% доплата за Windows
            'bulk_discount_threshold': 10,
            'bulk_discount_percent': 10.0,
            'priority': 10,
            'active': True,
        })
        created_count += 1

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Default Pricing Plans Created',
        'message': 'Created %s default pricing plans' % created_count,
        'type': 'success',
        'sticky': False,
    }
}
        </field>
    </record>

    <!-- Pricing Analysis Report server action -->
    <record id="action_pricing_analysis_report" model="ir.actions.server">
        <field name="name">Pricing Analysis Report</field>
        <field name="model_id" ref="model_hypervisor_server_pricing"/>
        <field name="state">code</field>
        <field name="code">
active_pricing = model.search([('active', '=', True)])
total_servers = env['hypervisor.server'].search_count([])
servers_with_pricing = len(set(active_pricing.mapped('server_id.id')))
coverage_percentage = (servers_with_pricing / total_servers * 100) if total_servers > 0 else 0

# Анализ цен
core_prices = active_pricing.mapped('price_per_core')
ram_prices = active_pricing.mapped('price_per_gb_ram')
disk_prices = active_pricing.mapped('price_per_gb_disk')

min_core_price = min(core_prices) if core_prices else 0
max_core_price = max(core_prices) if core_prices else 0
avg_core_price = sum(core_prices) / len(core_prices) if core_prices else 0
avg_ram_price = sum(ram_prices) / len(ram_prices) if ram_prices else 0
avg_disk_price = sum(disk_prices) / len(disk_prices) if disk_prices else 0

# Продукты с автоценообразованием
auto_price_products = env['product.template'].search_count([('auto_price_calculation', '=', True)])
total_vm_products = env['product.template'].search_count([('hypervisor_server_id', '!=', False)])
auto_pricing_adoption = (auto_price_products / total_vm_products * 100) if total_vm_products > 0 else 0

report = """Pricing Analysis Report:

=== SERVER COVERAGE ===
• Servers with pricing: %d/%d (%.1f%%)
• Active pricing plans: %d

=== PRICE ANALYSIS ===
• CPU Core prices: $%.2f - $%.2f (avg: $%.2f)
• RAM prices: avg $%.2f per GB
• Disk prices: avg $%.4f per GB

=== PRODUCT ADOPTION ===
• VM products with auto-pricing: %d/%d (%.1f%%)

Generated: %s
""" % (
    servers_with_pricing, total_servers, coverage_percentage,
    len(active_pricing),
    min_core_price, max_core_price, avg_core_price,
    avg_ram_price, avg_disk_price,
    auto_price_products, total_vm_products, auto_pricing_adoption,
    fields.Datetime.now().strftime('%Y-%m-%d %H:%M:%S')
)

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Pricing Analysis Report',
        'message': report,
        'type': 'info',
        'sticky': True,
    }
}
        </field>
    </record>

    <!-- VM Resource Statistics server action -->
    <record id="action_vm_resource_stats" model="ir.actions.server">
        <field name="name">Show Resource Statistics</field>
        <field name="model_id" ref="model_vm_rental_machine"/>
        <field name="state">code</field>
        <field name="code">
active_vms = model.search([('state', '=', 'active')])

if not active_vms:
    message = "No active VMs found in the system."
else:
    total_cores = sum(active_vms.mapped('cores'))
    total_memory = sum(active_vms.mapped('memory'))
    total_disk = sum(active_vms.mapped('disk'))

    avg_cores = total_cores / len(active_vms) if active_vms else 0
    avg_memory = total_memory / len(active_vms) if active_vms else 0
    avg_disk = total_disk / len(active_vms) if active_vms else 0

    message = """VM Resource Statistics:

Active VMs: %d
Total CPU Cores: %d
Total RAM: %.1f GB
Total Disk: %d GB

Average per VM:
- CPU: %.1f cores
- RAM: %.0f MB
- Disk: %.0f GB
""" % (
    len(active_vms), total_cores, total_memory / 1024, total_disk,
    avg_cores, avg_memory, avg_disk
)

action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'VM Resource Statistics',
        'message': message,
        'type': 'info',
        'sticky': True,
    }
}
        </field>
    </record>

    <!-- VM User Settings action -->
    <record id="action_vm_user_settings" model="ir.actions.act_window">
        <field name="name">VM User Settings</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module': 'vm_rental'}</field>
    </record>

    <!-- ===== BINDING ACTIONS TO MENUS ===== -->
    <!-- VM Management -->
    <menuitem id="menu_vm_instances" name="VM Instances" parent="menu_vm_management" action="action_vm_instances" sequence="10"/>
    <menuitem id="menu_vm_orders" name="VM Orders" parent="menu_vm_management" action="action_vm_orders" sequence="20"/>
    <menuitem id="menu_vm_snapshots" name="VM Snapshots" parent="menu_vm_management" action="action_vm_snapshots" sequence="30"/>
    <menuitem id="menu_link_existing_vms" name="Link Existing VMs" parent="menu_vm_management" action="action_linking_job" sequence="40"/>
    <menuitem id="menu_vm_config_wizard" name="Configuration Wizard" parent="menu_vm_management" action="action_vm_config_wizard" sequence="50"/>
    <menuitem id="menu_vm_bulk_operations" name="Bulk Operations" parent="menu_vm_management" action="action_vm_bulk_operations" sequence="60"/>

    <!-- Hypervisors -->
    <menuitem id="menu_hypervisor_servers" name="Hypervisor Servers" parent="menu_hypervisors" action="action_hypervisor_servers" sequence="10"/>
    <menuitem id="menu_hypervisor_templates" name="VM Templates" parent="menu_hypervisors" action="action_vm_templates" sequence="20"/>

    <!-- Pricing & Billing -->
    <menuitem id="menu_vm_pricing_plans" name="Pricing Plans" parent="menu_pricing_billing" action="action_vm_pricing_plans" sequence="10"/>
    <menuitem id="menu_vm_storage_pricing" name="Storage Pricing" parent="menu_pricing_billing" action="action_hypervisor_storage_pricing" sequence="15"/>
    <menuitem id="menu_vm_pricing_calculator" name="Pricing Calculator" parent="menu_pricing_billing" action="action_vm_pricing_calculator" sequence="20"/>
    <menuitem id="menu_vm_pricing_dashboard" name="Pricing Dashboard" parent="menu_pricing_billing" action="action_vm_pricing_dashboard" sequence="30"/>
    <menuitem id="menu_mass_price_update" name="Mass Price Update" parent="menu_pricing_billing" action="action_mass_price_update_wizard" sequence="40"/>

    <!-- Reports & Analytics -->
    <menuitem id="menu_vm_reports" name="VM Reports" parent="menu_reports_analytics" action="action_vm_reports" sequence="10"/>
    <menuitem id="menu_vm_admin_report" name="All Virtual Machines" parent="menu_reports_analytics" action="action_vm_admin_report" sequence="20"/>

    <!-- User Management -->
    <menuitem id="menu_vm_users_dashboard" name="VM Users Dashboard" parent="menu_vm_user_management_submenu" action="action_vm_users_dashboard" sequence="10"/>
    <menuitem id="menu_vm_admins_list" name="VM Administrators" parent="menu_vm_user_management_submenu" action="action_vm_admins_list" sequence="20"/>
    <menuitem id="menu_vm_managers_list" name="VM Managers" parent="menu_vm_user_management_submenu" action="action_vm_managers_list" sequence="30"/>
    <menuitem id="menu_users_without_vm_access" name="Users without VM Access" parent="menu_vm_user_management_submenu" action="action_users_without_vm_access" sequence="40"/>
    <menuitem id="menu_vm_user_settings" name="VM User Settings" parent="menu_vm_user_management_submenu" action="action_vm_user_settings" sequence="50"/>
    <menuitem id="menu_vm_user_manager" name="User Access Manager" parent="menu_vm_user_management_submenu" action="action_vm_user_manager" sequence="5" groups="base.group_system"/>

    <!-- Tools -->
    <menuitem id="menu_create_vm_products" name="Create VM Products" parent="menu_vm_tools_submenu" action="action_create_vm_products" sequence="10"/>
    <menuitem id="menu_update_product_prices" name="Update Product Prices" parent="menu_vm_tools_submenu" action="action_update_all_product_prices" sequence="20"/>
    <menuitem id="menu_create_default_pricing" name="Create Default Pricing Plans" parent="menu_vm_tools_submenu" action="action_create_default_pricing_plans" sequence="30"/>
    <menuitem id="menu_pricing_analysis" name="Pricing Analysis Report" parent="menu_vm_tools_submenu" action="action_pricing_analysis_report" sequence="40"/>
    <menuitem id="menu_vm_resource_stats" name="Resource Statistics" parent="menu_vm_tools_submenu" action="action_vm_resource_stats" sequence="50"/>

</odoo>